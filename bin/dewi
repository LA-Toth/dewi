#!/usr/bin/env python3
# vim: sts=4 ts=8 et ai

import time
start_time = time.time()

import errno
import os
import sys

if sys.hexversion < 0x3020000:
    print("DEWI requires Python 3.2.0 or newer")
    sys.exit(1)

def resolve_link_chain(path):
    try:
        os.stat(path)
    except os.error as err:
        # do not raise exception in case of broken symlink
        # we want to know the final target anyway
        if err.errno == errno.ENOENT:
            pass
        else:
            raise
    if not os.path.isabs(path):
        basedir = os.path.dirname(os.path.abspath(path))
    else:
        basedir = os.path.dirname(path)
    p = path
    while os.path.islink(p):
        p = os.readlink(p)
        if not os.path.isabs(p):
            p = os.path.join(basedir, p)
            basedir = os.path.dirname(p)
    return os.path.join(basedir, p)

root_dir = os.path.dirname(os.path.dirname(os.path.abspath(resolve_link_chain(os.path.abspath(sys.argv[0])))))

expected_file_name = os.path.join(root_dir, 'bin', 'dewi')
if os.path.samefile(sys.argv[0], expected_file_name):
    os.environ['ZWA_ROOT'] = root_dir
else:
    print("The script started as a symlink doesn't point to DEWI's own script (to '{}')".format(expected_file_name))
    sys.exit(1)

lib_dir = os.path.join(root_dir, 'lib')
sys.path.append(lib_dir)

from dewi.main import app_main
app_main(start_time)
